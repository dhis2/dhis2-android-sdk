name: Deploy

on:
  # Called by CI workflow when deployment is needed
  workflow_call:
    secrets:
      SONATYPE_PORTAL_USERNAME:
        required: true
      SONATYPE_PORTAL_PASSWORD:
        required: true
  # Allow manual deployment
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if not on develop or RC branch'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true
    -Dorg.gradle.configuration-cache=true
    -Dkotlin.incremental=true
    -Dkotlin.compiler.execution.strategy=in-process

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: Check deployment conditions
        id: check
        run: |
          BRANCH="${{ github.ref_name }}"
          
          # Check if it's a valid branch for deployment
          if [[ "$BRANCH" == "develop" ]] || [[ "$BRANCH" =~ -rc$ ]] || [[ "$BRANCH" =~ -RC$ ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment allowed for branch: $BRANCH"
          elif [ "${{ inputs.force_deploy }}" == "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Forced deployment for branch: $BRANCH"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Deployment skipped: Branch $BRANCH is not develop or RC"
          fi

  deploy:
    name: Deploy to Sonatype
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Publish to Sonatype
        run: ./gradlew :core:publishToSonatype
        env:
          NEXUS_USERNAME: ${{ secrets.SONATYPE_PORTAL_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.SONATYPE_PORTAL_PASSWORD }}
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(./gradlew -q printVersion 2>/dev/null || echo "unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Published to Sonatype Nexus" >> $GITHUB_STEP_SUMMARY

