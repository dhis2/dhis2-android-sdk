name: Deploy

on:
  push:
    branches:
      - develop
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - develop
      - '*-rc'
  # Allow manual deployment
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if not on develop or RC branch'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true
    -Dorg.gradle.configuration-cache=true
    -Dkotlin.incremental=true
    -Dkotlin.compiler.execution.strategy=in-process

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: Check CI workflow success
        id: ci_check
        run: |
          # If triggered by workflow_run, check that CI was successful
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "âŒ CI workflow did not succeed. Conclusion: ${{ github.event.workflow_run.conclusion }}"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âœ… CI workflow succeeded"
            fi
          fi
      
      - name: Check deployment conditions
        id: check
        run: |
          # Check if it's a PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Deployment skipped: Pull Request builds are not deployed"
            exit 0
          fi
          
          # For workflow_run events, use the head branch
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          # Check if it's a valid branch
          if [[ "$BRANCH" == "develop" ]] || [[ "$BRANCH" =~ ^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?-rc$ ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment allowed for branch: $BRANCH"
          elif [ "${{ inputs.force_deploy }}" == "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Forced deployment for branch: $BRANCH"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Deployment skipped: Branch $BRANCH is not develop or RC"
          fi

  deploy:
    name: Deploy to Sonatype
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the commit that triggered CI
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Publish to Sonatype
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: ./gradlew :core:publishToSonatype
        env:
          NEXUS_USERNAME: ${{ secrets.SONATYPE_PORTAL_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.SONATYPE_PORTAL_PASSWORD }}
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(./gradlew -q printVersion 2>/dev/null || echo "unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Published to Sonatype Nexus" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: success() && needs.validate.outputs.should_deploy == 'true'
    
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "*Deployment Successful*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Successful* :white_check_mark:\n*Job:* ${{ github.workflow }}\n*Branch:* ${{ github.ref_name }}\n*Run Number:* ${{ github.run_number }} (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open>)\n*Published to:* Sonatype Nexus"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: failure() && needs.validate.outputs.should_deploy == 'true'
    
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "*Deployment Failed*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Failed* :x:\n*Job:* ${{ github.workflow }}\n*Branch:* ${{ github.ref_name }}\n*Run Number:* ${{ github.run_number }} (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open>)"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
