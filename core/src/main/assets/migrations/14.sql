CREATE TABLE RelationshipConstraint (_id INTEGER PRIMARY KEY AUTOINCREMENT, relationshipType TEXT NOT NULL, constraintType TEXT NOT NULL, relationshipEntity TEXT, trackedEntityType TEXT, program TEXT, programStage TEXT, FOREIGN KEY (trackedEntityType) REFERENCES TrackedEntityType (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (program) REFERENCES Program (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (programStage) REFERENCES ProgramStage (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, UNIQUE (relationshipType, constraintType));
CREATE TABLE RelationshipItem (_id INTEGER PRIMARY KEY AUTOINCREMENT, relationship TEXT NOT NULL, relationshipItemType TEXT NOT NULL, trackedEntityInstance TEXT, enrollment TEXT, event TEXT, FOREIGN KEY (relationship) REFERENCES Relationship (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED  FOREIGN KEY (trackedEntityInstance) REFERENCES TrackedEntityInstance (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (enrollment) REFERENCES Enrollment (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (event) REFERENCES Event (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED);
INSERT INTO RelationshipItem (relationship, relationshipItemType, trackedEntityInstance) SELECT _id, 'FROM', trackedEntityInstanceA FROM Relationship;
INSERT INTO RelationshipItem (relationship, relationshipItemType, trackedEntityInstance) SELECT _id, 'TO', trackedEntityInstanceB FROM Relationship;
CREATE TABLE Relationship_temp (_id INTEGER PRIMARY KEY AUTOINCREMENT, uid TEXT NOT NULL UNIQUE, code TEXT, name TEXT, displayName TEXT, created TEXT, lastUpdated TEXT, relationshipType TEXT NOT NULL, FOREIGN KEY (relationshipType) REFERENCES RelationshipType (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED);
INSERT INTO Relationship_temp SELECT _id, _id, null, null, null, null, null, relationshipType FROM Relationship;
DROP TABLE IF EXISTS Relationship;
ALTER TABLE Relationship_temp RENAME TO Relationship;
CREATE TABLE TrackedEntityInstance_temp (_id INTEGER PRIMARY KEY AUTOINCREMENT, uid TEXT NOT NULL UNIQUE, created TEXT, lastUpdated TEXT, createdAtClient TEXT, lastUpdatedAtClient TEXT, organisationUnit TEXT, trackedEntityType TEXT, coordinates TEXT, featureType TEXT, state TEXT, FOREIGN KEY (organisationUnit) REFERENCES OrganisationUnit (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (trackedEntityType) REFERENCES TrackedEntityType (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED);
INSERT INTO TrackedEntityInstance_temp SELECT * FROM TrackedEntityInstance;
DROP TABLE IF EXISTS TrackedEntityInstance;
ALTER TABLE TrackedEntityInstance_temp RENAME TO TrackedEntityInstance;
