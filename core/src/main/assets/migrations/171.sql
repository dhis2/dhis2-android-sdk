# Migration fix for Aggregated Sync State Bug for Event, Enrollment, and TrackedEntityInstance (ANDROSDK-2067)

WITH CONSTANTS(synced, relationship) AS (SELECT 'SYNCED','RELATIONSHIP'), ValidEvents AS (SELECT e.uid, c.synced FROM Event e CROSS JOIN CONSTANTS c LEFT JOIN Note n ON n.event = e.uid AND n.syncState != c.synced LEFT JOIN TrackedEntityDataValue t ON t.event = e.uid AND t.syncState != c.synced LEFT JOIN (SELECT RI.event FROM RelationshipItem RI JOIN Relationship R ON RI.relationship = R.uid CROSS JOIN CONSTANTS c2 WHERE R.syncState != c2.synced) rel ON rel.event = e.uid WHERE e.aggregatedSyncState NOT IN (c.synced, c.relationship) AND e.syncState IN (c.synced, c.relationship) AND n.event IS NULL AND t.event IS NULL AND rel.event IS NULL) UPDATE Event SET aggregatedSyncState = (SELECT synced FROM CONSTANTS) WHERE uid IN (SELECT uid FROM ValidEvents);
WITH CONSTANTS(synced, relationship) AS (SELECT 'SYNCED','RELATIONSHIP'), ValidEnrollments AS (SELECT e.uid, c.synced FROM Enrollment e CROSS JOIN CONSTANTS c LEFT JOIN Event ev ON ev.enrollment = e.uid AND ev.syncState != c.synced LEFT JOIN Note n ON n.enrollment = e.uid AND n.syncState != c.synced LEFT JOIN (SELECT RI.enrollment FROM RelationshipItem RI JOIN Relationship R ON RI.relationship = R.uid CROSS JOIN CONSTANTS c2 WHERE R.syncState != c2.synced) rel ON rel.enrollment = e.uid WHERE e.aggregatedSyncState NOT IN (c.synced, c.relationship) AND e.syncState IN (c.synced, c.relationship) AND ev.enrollment IS NULL AND n.enrollment IS NULL AND rel.enrollment IS NULL) UPDATE Enrollment SET aggregatedSyncState = (SELECT synced FROM CONSTANTS) WHERE uid IN (SELECT uid FROM ValidEnrollments);
WITH CONSTANTS(synced, relationship) AS (SELECT 'SYNCED','RELATIONSHIP'), ValidTEIs AS (SELECT tei.uid, c.synced FROM TrackedEntityInstance tei CROSS JOIN CONSTANTS c LEFT JOIN Enrollment en ON en.trackedEntityInstance = tei.uid AND en.aggregatedSyncState != c.synced LEFT JOIN ProgramOwner po ON po.trackedEntityInstance = tei.uid AND po.syncState != c.synced LEFT JOIN TrackedEntityAttributeValue teav ON teav.trackedEntityInstance = tei.uid AND teav.syncState != c.synced LEFT JOIN (SELECT RI.trackedEntityInstance FROM RelationshipItem RI JOIN Relationship R ON RI.relationship = R.uid CROSS JOIN CONSTANTS c2 WHERE R.syncState != c2.synced) rel ON rel.trackedEntityInstance = tei.uid WHERE tei.aggregatedSyncState NOT IN (c.synced, c.relationship) AND tei.syncState IN (c.synced, c.relationship) AND en.uid IS NULL AND po.trackedEntityInstance IS NULL AND teav.trackedEntityInstance IS NULL AND rel.trackedEntityInstance IS NULL) UPDATE TrackedEntityInstance SET aggregatedSyncState = (SELECT synced FROM CONSTANTS) WHERE uid IN (SELECT uid FROM ValidTEIs);
