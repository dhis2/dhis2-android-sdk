# Migration fix for Aggregated Sync State Bug for Event, Enrollment, and TrackedEntityInstance (ANDROSDK-2067)

UPDATE Event SET aggregatedSyncState = 'SYNCED' WHERE aggregatedSyncState NOT IN ('SYNCED','RELATIONSHIP') AND syncState IN ('SYNCED','RELATIONSHIP') AND NOT EXISTS (SELECT 1 FROM Note WHERE Note.event = Event.uid AND Note.syncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM TrackedEntityDataValue WHERE TrackedEntityDataValue.event = Event.uid AND TrackedEntityDataValue.syncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM RelationshipItem RI JOIN Relationship R ON RI.relationship = R.uid WHERE RI.event = Event.uid AND R.syncState != 'SYNCED');
UPDATE Enrollment SET aggregatedSyncState = 'SYNCED' WHERE aggregatedSyncState NOT IN ('SYNCED','RELATIONSHIP') AND syncState IN ('SYNCED','RELATIONSHIP') AND NOT EXISTS (SELECT 1 FROM Event WHERE Event.enrollment = Enrollment.uid AND Event.syncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM Note WHERE Note.enrollment = Enrollment.uid AND Note.syncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM RelationshipItem RI JOIN Relationship R ON RI.relationship = R.uid WHERE RI.enrollment = Enrollment.uid AND R.syncState != 'SYNCED');
UPDATE TrackedEntityInstance SET aggregatedSyncState = 'SYNCED' WHERE aggregatedSyncState NOT IN ('SYNCED','RELATIONSHIP') AND syncState IN ('SYNCED','RELATIONSHIP') AND NOT EXISTS (SELECT 1 FROM Enrollment WHERE Enrollment.trackedEntityInstance = TrackedEntityInstance.uid AND Enrollment.aggregatedSyncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM ProgramOwner WHERE ProgramOwner.trackedEntityInstance = TrackedEntityInstance.uid AND ProgramOwner.syncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM TrackedEntityAttributeValue WHERE TrackedEntityAttributeValue.trackedEntityInstance = TrackedEntityInstance.uid AND TrackedEntityAttributeValue.syncState != 'SYNCED') AND NOT EXISTS (SELECT 1 FROM RelationshipItem RI JOIN Relationship R ON RI.relationship = R.uid WHERE RI.trackedEntityInstance = TrackedEntityInstance.uid AND R.syncState != 'SYNCED');
