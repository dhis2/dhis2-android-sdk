# Migration fix for Aggregated Sync State Bug for Event, Enrollment, and TrackedEntityInstance (ANDROSDK-2067)

SET @synced = 'SYNCED', @relationship = 'RELATIONSHIP';
UPDATE Event e LEFT JOIN Note n ON n.event = e.uid AND n.syncState <> @synced LEFT JOIN TrackedEntityDataValue tdv ON tdv.event = e.uid AND tdv.syncState <> @synced LEFT JOIN RelationshipItem ri ON ri.event = e.uid LEFT JOIN Relationship r ON ri.relationship = r.uid AND r.syncState <> @synced SET e.aggregatedSyncState = @synced WHERE e.aggregatedSyncState NOT IN (@synced, @relationship) AND e.syncState IN (@synced, @relationship) AND n.uid IS NULL AND tdv.uid IS NULL AND r.uid IS NULL;
UPDATE Enrollment e LEFT JOIN Event ev ON ev.enrollment = e.uid AND ev.syncState <> @synced LEFT JOIN Note n ON n.enrollment = e.uid AND n.syncState <> @synced LEFT JOIN RelationshipItem ri ON ri.enrollment = e.uid LEFT JOIN Relationship r ON ri.relationship = r.uid AND r.syncState <> @synced SET e.aggregatedSyncState = @synced WHERE e.aggregatedSyncState NOT IN (@synced, @relationship) AND e.syncState IN (@synced, @relationship) AND ev.uid IS NULL AND n.uid IS NULL AND r.uid IS NULL;
UPDATE TrackedEntityInstance tei LEFT JOIN Enrollment e ON e.trackedEntityInstance = tei.uid AND e.aggregatedSyncState <> @synced LEFT JOIN ProgramOwner po ON po.trackedEntityInstance = tei.uid AND po.syncState <> @synced LEFT JOIN TrackedEntityAttributeValue teav ON teav.trackedEntityInstance = tei.uid AND teav.syncState <> @synced LEFT JOIN RelationshipItem ri ON ri.trackedEntityInstance = tei.uid LEFT JOIN Relationship r ON ri.relationship = r.uid AND r.syncState <> @synced SET tei.aggregatedSyncState = @synced WHERE tei.aggregatedSyncState NOT IN (@synced, @relationship) AND tei.syncState IN (@synced, @relationship) AND e.uid IS NULL AND po.uid IS NULL AND teav.uid IS NULL AND r.uid IS NULL;
